
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¾å°„è…«ç˜¤éƒ¨å¹¸é‹å®šä½ç³»çµ±</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* è‡ªå®šç¾©å­—å‹èˆ‡å‹•ç•« */
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Noto+Sans+TC:wght@400;700;900&display=swap');

        body {
            font-family: 'JetBrains Mono', 'Noto Sans TC', monospace;
            background-color: #111827; /* gray-900 */
            color: #4ade80; /* green-400 */
        }

        .grid-bg {
            background-image: 
                linear-gradient(0deg, transparent 24%, #00ff00 25%, #00ff00 26%, transparent 27%, transparent 74%, #00ff00 75%, #00ff00 76%, transparent 77%, transparent), 
                linear-gradient(90deg, transparent 24%, #00ff00 25%, #00ff00 26%, transparent 27%, transparent 74%, #00ff00 75%, #00ff00 76%, transparent 77%, transparent);
            background-size: 50px 50px;
            opacity: 0.1;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }

        @keyframes scan-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-scan-spin {
            animation: scan-spin 2s linear infinite;
        }

        @keyframes pulse-fast {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-fast {
            animation: pulse-fast 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .stripe-pattern {
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, #000 10px, #000 20px);
            opacity: 0.2;
        }

        /* ä¸­çç‰¹æ•ˆ */
        .winner-effect {
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.9); /* å¢å¼·ç™¼å…‰ */
            transform: scale(1.1);
            color: white !important;
        }
        
        /* éš±è—å…ƒç´  */
        .hidden {
            display: none !important;
        }

        /* Toast å‹•ç•« */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .animate-toast {
            animation: fadeInOut 3s ease-in-out forwards;
        }
        
        /* è—é ­è©©ç™¼å…‰æ•ˆæœ */
        .poem-text {
            text-shadow: 0 0 5px rgba(74, 222, 128, 0.3);
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden relative selection:bg-green-900 selection:text-white">

    <!-- èƒŒæ™¯ç¶²æ ¼ -->
    <div class="absolute inset-0 pointer-events-none grid-bg"></div>

    <!-- Header -->
    <header class="p-4 border-b border-green-800 flex justify-between items-center bg-gray-900/90 z-10 shadow-[0_0_15px_rgba(0,255,0,0.2)]">
        <div class="flex items-center gap-3">
            <div class="relative">
                <i data-lucide="radiation" id="header-icon" class="w-8 h-8 text-green-500 transition-colors duration-300"></i>
                <div id="header-glow" class="absolute inset-0 bg-yellow-400 opacity-0 blur-lg rounded-full transition-opacity duration-300"></div>
            </div>
            <div>
                <h1 class="text-xl font-bold tracking-widest text-white">RAD-ONC LOTTERY</h1>
                <p class="text-xs text-green-600">æ”¾å°„è…«ç˜¤éƒ¨ å¹¸é‹å®šä½ç³»çµ± V1.0</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div class="text-right hidden md:block mr-2">
                <p class="text-xs text-gray-400">STATUS</p>
                <p id="status-text" class="text-sm font-bold text-green-400">READY</p>
            </div>
            
            <!-- éŸ³æ•ˆé–‹é—œ -->
            <button id="btn-sound" onclick="toggleSound()" class="p-2 hover:bg-green-900/50 rounded transition border border-green-800 text-green-400 hover:text-white" title="åˆ‡æ›éŸ³æ•ˆ">
                <i data-lucide="volume-2" id="icon-sound" class="w-5 h-5"></i>
            </button>

            <!-- é‡ç½®æŒ‰éˆ• -->
            <button onclick="openResetModal()" class="flex items-center gap-2 px-3 py-2 bg-red-900/30 hover:bg-red-900/80 border border-red-800 text-red-400 hover:text-white rounded transition-all" title="é‡ç½®ç³»çµ±">
                <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                <span class="text-xs font-bold hidden sm:inline">é‡ç½®</span>
            </button>

            <button onclick="openSettings()" class="p-2 hover:bg-green-900/50 rounded transition border border-green-800 text-green-400 hover:text-white" title="è¨­å®šåå–®">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col md:flex-row p-4 gap-4 relative z-0 h-full overflow-hidden">
        
        <!-- Left: Control & Display Area -->
        <div class="flex-1 flex flex-col gap-4 min-h-0">
            
            <!-- Main Display Screen -->
            <div class="flex-1 border-2 border-green-700 bg-black relative rounded-lg overflow-hidden shadow-[0_0_30px_rgba(0,255,0,0.1)] flex flex-col items-center justify-center min-h-[300px]">
                
                <!-- Screen Corners -->
                <div class="absolute top-2 left-2 w-4 h-4 border-l-2 border-t-2 border-green-500"></div>
                <div class="absolute top-2 right-2 w-4 h-4 border-r-2 border-t-2 border-green-500"></div>
                <div class="absolute bottom-2 left-2 w-4 h-4 border-l-2 border-b-2 border-green-500"></div>
                <div class="absolute bottom-2 right-2 w-4 h-4 border-r-2 border-b-2 border-green-500"></div>

                <!-- Scanning Crosshair (Overlay) -->
                <div id="scan-overlay" class="absolute inset-0 pointer-events-none transition-opacity duration-300 opacity-20">
                     <div class="absolute top-1/2 left-0 w-full h-[1px] bg-green-500/50"></div>
                     <div class="absolute left-1/2 top-0 h-full w-[1px] bg-green-500/50"></div>
                     <div id="scan-circle" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 border border-green-500/30 rounded-full w-64 h-64 transition-all duration-300"></div>
                     <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 border-2 border-green-500 rounded-full w-48 h-48"></div>
                </div>

                <!-- Target Info Overlay -->
                <div class="absolute top-4 left-4 text-xs text-green-600 font-mono">
                    <p>TARGET_ID: <span id="target-status">SEARCHING...</span></p>
                    <p>DOSE_RATE: <span id="dose-rate">0</span> MU/min</p>
                    <p>GANTRY: <span id="gantry-angle">0.0</span>Â°</p>
                </div>

                <!-- The Name Display (æ”¾å¤§ç‰ˆ) -->
                <div class="relative z-10 text-center px-4 w-full">
                    <div id="locked-msg" class="text-yellow-400 text-lg md:text-xl mb-4 font-bold tracking-widest hidden animate-bounce">
                        âš  TARGET LOCKED âš 
                    </div>
                    <!-- åå­—æ”¾å¤§ï¼štext-7xl (æ‰‹æ©Ÿ) åˆ° text-9xl (é›»è…¦) -->
                    <h2 id="display-name" class="text-7xl md:text-9xl font-black tracking-wider transition-all duration-100 text-green-500 break-words leading-tight drop-shadow-2xl">
                        ç³»çµ±å°±ç·’
                    </h2>
                    <div id="congrats-tag" class="mt-8 hidden">
                       <!-- æ­å–œä¸­çæ”¾å¤§ï¼šå¢åŠ  padding å’Œå­—é«”å¤§å° -->
                       <div class="inline-block px-8 py-3 bg-yellow-500 text-black font-extrabold text-3xl md:text-4xl rounded-lg transform -rotate-2 shadow-[0_0_20px_rgba(234,179,8,0.8)] border-4 border-yellow-300">
                           ğŸ‰ æ­å–œä¸­ç ğŸ‰
                       </div>
                    </div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="h-auto md:h-32 bg-gray-800 border-t-4 border-green-600 rounded-lg p-4 flex flex-col md:flex-row items-center justify-between shadow-lg gap-4">
                <div class="flex flex-col w-full md:w-auto text-center md:text-left">
                    <span class="text-gray-400 text-xs uppercase tracking-wider">Remaining Targets</span>
                    <span class="text-3xl font-bold text-white">
                        <span id="count-remaining">0</span> 
                        <span class="text-sm text-gray-500">/ <span id="count-total">0</span></span>
                    </span>
                </div>

                <!-- è—é ­è©© (æ”¾ç½®æ–¼æŒ‰éˆ•æ—çš„ç©ºç™½è™•) -->
                <div class="flex flex-col items-center justify-center space-y-1 opacity-60 mx-4 select-none">
                    <p class="text-xs text-green-500 font-bold tracking-[0.3em] poem-text">å¥‡æº–é–ç—…ç¶</p>
                    <p class="text-xs text-green-500 font-bold tracking-[0.3em] poem-text">ç¾ç­–è­·å®‰åº·</p>
                    <p class="text-xs text-green-500 font-bold tracking-[0.3em] poem-text">æ”¾æŸå¾ªè»Œæ­£</p>
                    <p class="text-xs text-green-500 font-bold tracking-[0.3em] poem-text">è…«æ¶ˆå®ˆå¹³é•·</p>
                </div>

                <div class="flex gap-4 w-full md:w-auto justify-center">
                    <!-- Beam On Button -->
                    <button id="btn-beam" onclick="startTreatment()" class="relative group overflow-hidden px-8 py-4 rounded-md font-bold text-xl tracking-wider transition-all bg-red-600 hover:bg-red-500 text-white shadow-[0_0_20px_rgba(220,38,38,0.6)] hover:scale-105 active:scale-95 disabled:bg-gray-700 disabled:text-gray-500 disabled:shadow-none disabled:cursor-not-allowed w-full md:w-auto">
                        <span class="relative z-10 flex items-center justify-center gap-2">
                            <i data-lucide="radiation" id="btn-icon-beam" class=""></i>
                            <span id="btn-text-beam">BEAM ON</span>
                        </span>
                        <div class="absolute inset-0 stripe-pattern pointer-events-none"></div>
                    </button>

                    <!-- Next Button (Hidden initially) -->
                    <button id="btn-next" onclick="nextFraction()" class="hidden px-8 py-4 bg-cyan-600 hover:bg-cyan-500 text-white font-bold text-xl rounded-md shadow-[0_0_20px_rgba(8,145,178,0.6)] hover:scale-105 transition-all flex items-center justify-center gap-2 w-full md:w-auto">
                        <i data-lucide="play" class="fill-current"></i>
                        NEXT FRACTION
                    </button>
                </div>
            </div>
        </div>

        <!-- Right: Lists (Sidebar) -->
        <div class="w-full md:w-80 flex flex-col gap-4 min-h-[300px]">
            
            <!-- Winners List -->
            <div class="flex-1 bg-gray-800/80 border border-green-800 rounded-lg p-4 overflow-hidden flex flex-col">
                <div class="flex items-center gap-2 mb-4 border-b border-green-700 pb-2">
                    <i data-lucide="trophy" class="text-yellow-400 w-5 h-5"></i>
                    <h3 class="font-bold text-white">å·²ä¸­çåå–® (Treated)</h3>
                </div>
                <div id="winners-list" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar">
                    <!-- Winners will be injected here -->
                    <div class="text-center text-gray-500 py-8 text-sm italic">No treatment history.</div>
                </div>
            </div>

            <!-- Candidates Preview -->
            <div class="h-1/3 bg-gray-800/80 border border-gray-700 rounded-lg p-4 flex flex-col">
                 <div class="flex items-center gap-2 mb-2">
                    <i data-lucide="users" class="text-gray-400 w-4 h-4"></i>
                    <h3 class="font-bold text-gray-400 text-sm">å¾…æŠ½åå–® (Pending)</h3>
                </div>
                <div id="candidates-preview" class="flex-1 overflow-y-auto text-xs text-gray-500 font-mono custom-scrollbar break-all">
                    <!-- Candidate names preview -->
                </div>
            </div>

        </div>
    </main>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 border-2 border-green-600 w-full max-w-lg rounded-lg shadow-[0_0_50px_rgba(0,255,0,0.2)] p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                    <i data-lucide="activity" class="text-green-500"></i>
                    ç³»çµ±åƒæ•¸è¨­å®š
                </h2>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-white">âœ•</button>
            </div>
            
            <div class="mb-4">
                <label class="block text-green-400 text-sm mb-2 font-mono">è¼¸å…¥å€™é¸äººåå–® (ä¸€è¡Œä¸€å€‹åå­—):</label>
                <textarea id="settings-input" class="w-full h-64 bg-black border border-green-700 text-white p-3 font-mono text-sm focus:outline-none focus:border-green-400 rounded" placeholder="è«‹è²¼ä¸Šåå–®..."></textarea>
                <div class="text-right text-xs text-gray-500 mt-1">
                    ç›®å‰äººæ•¸: <span id="settings-count">0</span>
                </div>
            </div>

            <div class="flex justify-end items-center gap-4">
                <button onclick="saveSettings()" class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-500 text-white font-bold rounded shadow-[0_0_10px_rgba(0,255,0,0.4)] transition-all">
                    ç¢ºèªä¸¦è¼‰å…¥åå–®
                </button>
            </div>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div id="reset-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[60] flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 border-2 border-red-600 w-full max-w-sm rounded-lg p-6 shadow-[0_0_50px_rgba(220,38,38,0.2)]">
            <h3 class="text-xl font-bold text-red-500 mb-4 flex items-center gap-2">
                <i data-lucide="alert-triangle"></i> ç³»çµ±è­¦å‘Š
            </h3>
            <p class="text-gray-300 mb-6 text-sm leading-relaxed">
                ç¢ºå®šè¦åŸ·è¡Œç³»çµ±é‡ç½®å—ï¼Ÿ<br><br>
                é€™å°‡æœƒï¼š<br>
                1. æ¸…ç©ºã€Œå·²ä¸­çåå–®ã€<br>
                2. å°‡æ‰€æœ‰äººé‚„åŸå›ã€Œå¾…æŠ½åå–®ã€<br><br>
                <span class="text-yellow-500 font-bold">âš ï¸ æ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚</span>
            </p>
            <div class="flex gap-3">
                <button onclick="closeResetModal()" class="flex-1 px-4 py-3 border border-gray-600 rounded text-gray-400 hover:bg-gray-700 hover:text-white transition-colors">
                    å–æ¶ˆ
                </button>
                <button onclick="confirmFullReset()" class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded shadow-lg transition-colors">
                    ç¢ºèªé‡ç½®
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-container" class="fixed top-20 right-4 z-[70] pointer-events-none"></div>

    <!-- JavaScript Logic -->
    <script>
        // --- éŸ³æ•ˆæ§åˆ¶å™¨ (Web Audio API) ---
        // ä½¿ç”¨ç€è¦½å™¨å…§å»ºåˆæˆå™¨ï¼Œä¸éœ€å¤–éƒ¨æª”æ¡ˆ
        const AudioCtrl = {
            ctx: null,
            enabled: true,
            
            init() {
                if (!this.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            },

            toggle() {
                this.enabled = !this.enabled;
                // æ›´æ–°åœ–ç¤º
                const icon = document.getElementById('icon-sound');
                if (this.enabled) {
                    icon.setAttribute('data-lucide', 'volume-2');
                    this.playScan(); // æ¸¬è©¦éŸ³
                } else {
                    icon.setAttribute('data-lucide', 'volume-x');
                }
                lucide.createIcons();
                return this.enabled;
            },

            // æ’­æ”¾å–®éŸ³
            playTone(freq, duration, type = 'sine', vol = 0.1) {
                if (!this.enabled || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                
                // è²éŸ³åŒ…çµ¡ (Envelope)
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },

            // æƒæéŸ³æ•ˆï¼šæ¨¡ä»¿è“‹é©è¨ˆæ•¸å™¨æˆ–é«˜ç§‘æŠ€é‹ç®—
            playScan() {
                // éš¨æ©Ÿé »ç‡ç”¢ç”Ÿã€Œæ•¸æ“šé‹ç®—æ„Ÿã€
                const freq = 800 + Math.random() * 400;
                this.playTone(freq, 0.05, 'square', 0.05);
            },

            // ä¸­çéŸ³æ•ˆï¼šæˆåŠŸé–å®š (å¤§èª¿ç¶éŸ³)
            playWin() {
                if (!this.enabled || !this.ctx) return;
                const now = this.ctx.currentTime;
                // C Major Arpeggio (C5, E5, G5, C6)
                const notes = [523.25, 659.25, 783.99, 1046.50];
                
                notes.forEach((freq, i) => {
                     const osc = this.ctx.createOscillator();
                     const gain = this.ctx.createGain();
                     osc.type = 'triangle';
                     osc.frequency.setValueAtTime(freq, now + i * 0.1);
                     
                     gain.gain.setValueAtTime(0.1, now + i * 0.1);
                     gain.gain.linearRampToValueAtTime(0, now + i * 0.1 + 0.4);
                     
                     osc.connect(gain);
                     gain.connect(this.ctx.destination);
                     osc.start(now + i * 0.1);
                     osc.stop(now + i * 0.1 + 0.4);
                });
                
                // æœ€å¾ŒåŠ ä¸€å€‹ä½éŸ³è½Ÿé³´å¢åŠ éœ‡æ’¼æ„Ÿ
                this.playTone(130.81, 1.0, 'sawtooth', 0.15); // C3
            }
        };

        // --- åˆå§‹åŒ–è³‡æ–™ ---
        const defaultCandidates = [
            "é™³ä¸»ä»»", "æé†«å¸«", "ç‹ç‰©ç†å¸«", "å¼µæ”¾å°„å¸«", "æ—è­·ç†é•·", 
            "å³æ›¸è¨˜", "åŠ‰é†«å¸«", "é»ƒä½é™¢é†«å¸«", "è¶™ç ”ç©¶å“¡", "å­«å·¥ç¨‹å¸«",
            "å‘¨å°ˆç§‘è­·ç†å¸«", "é„­å€‹ç®¡å¸«", "è¬æŠ€è¡“é•·", "é¦¬ç‰©ç†å¸«", "è”¡æ”¾å°„å¸«"
        ];
        const STORAGE_KEY = 'rad_onc_lottery_v1';

        let state = {
            candidates: [...defaultCandidates],
            winners: [],
            isScanning: false,
            showResult: false
        };

        let scanInterval = null;
        let soundInterval = null;
        let gantryInterval = null;

        // --- DOM Elements ---
        const els = {
            displayName: document.getElementById('display-name'),
            lockedMsg: document.getElementById('locked-msg'),
            congratsTag: document.getElementById('congrats-tag'),
            countRemaining: document.getElementById('count-remaining'),
            countTotal: document.getElementById('count-total'),
            btnBeam: document.getElementById('btn-beam'),
            btnNext: document.getElementById('btn-next'),
            btnIconBeam: document.getElementById('btn-icon-beam'),
            btnTextBeam: document.getElementById('btn-text-beam'),
            winnersList: document.getElementById('winners-list'),
            candidatesPreview: document.getElementById('candidates-preview'),
            settingsModal: document.getElementById('settings-modal'),
            settingsInput: document.getElementById('settings-input'),
            settingsCount: document.getElementById('settings-count'),
            statusText: document.getElementById('status-text'),
            headerIcon: document.getElementById('header-icon'),
            headerGlow: document.getElementById('header-glow'),
            scanOverlay: document.getElementById('scan-overlay'),
            scanCircle: document.getElementById('scan-circle'),
            targetStatus: document.getElementById('target-status'),
            doseRate: document.getElementById('dose-rate'),
            gantryAngle: document.getElementById('gantry-angle'),
            resetModal: document.getElementById('reset-modal'),
            toastContainer: document.getElementById('toast-container')
        };

        // --- æœ¬åœ°å„²å­˜é‚è¼¯ (LocalStorage) ---
        function loadState() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (Array.isArray(parsed.candidates) && Array.isArray(parsed.winners)) {
                        state.candidates = parsed.candidates;
                        state.winners = parsed.winners;
                        console.log("å·²å¾æœ¬åœ°å„²å­˜è¼‰å…¥é€²åº¦");
                    }
                }
            } catch (e) {
                console.error("è¼‰å…¥å„²å­˜æª”å¤±æ•—", e);
            }
        }

        function saveState() {
            try {
                const dataToSave = {
                    candidates: state.candidates,
                    winners: state.winners
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
            } catch (e) {
                console.error("å„²å­˜å¤±æ•—", e);
            }
        }

        // --- åˆå§‹åŒ– ---
        function init() {
            try {
                loadState(); 
                updateUI();
                if(els.settingsInput) {
                    els.settingsInput.value = state.candidates.join('\n');
                    els.settingsInput.addEventListener('input', updateSettingsCount);
                }
                updateSettingsCount();
                if(window.lucide) {
                    lucide.createIcons();
                }
                
                // åˆå§‹åŒ–éŸ³æ•ˆ (ä½¿ç”¨è€…ç¬¬ä¸€æ¬¡é»æ“Šé é¢æ™‚æœƒè¢«è§¸ç™¼ï¼Œé€™è£¡å…ˆä¸å¼·åˆ¶)
                document.body.addEventListener('click', () => AudioCtrl.init(), { once: true });
            } catch(e) {
                console.error("Init error:", e);
            }
        }

        function toggleSound() {
            AudioCtrl.init(); // ç¢ºä¿æœ‰é»æ“Šæ™‚å•Ÿå‹• Context
            const isEnabled = AudioCtrl.toggle();
            showToast(isEnabled ? "éŸ³æ•ˆå·²é–‹å•Ÿ" : "éŸ³æ•ˆå·²éœéŸ³");
        }

        function updateSettingsCount() {
            if(!els.settingsInput) return;
            const count = els.settingsInput.value.split('\n').filter(n => n.trim() !== '').length;
            els.settingsCount.innerText = count;
        }

        // --- æ ¸å¿ƒé‚è¼¯ ---
        function startTreatment() {
            if (state.candidates.length === 0) return;
            
            // ç¢ºä¿éŸ³æ•ˆå¼•æ“å•Ÿå‹•
            AudioCtrl.init();

            state.isScanning = true;
            state.showResult = false;
            updateUI();

            els.doseRate.innerText = "600";
            
            let counter = 0;
            // ç•«é¢è·³å‹•
            scanInterval = setInterval(() => {
                const randomIndex = Math.floor(Math.random() * state.candidates.length);
                els.displayName.innerText = state.candidates[randomIndex];
                counter++;
            }, 50);

            // è²éŸ³è·³å‹• (ä¸éœ€è¦è·Ÿç•«é¢ä¸€æ¨£å¿«ï¼Œæ¯ 100ms éŸ¿ä¸€æ¬¡æ¯”è¼ƒä¸åµ)
            soundInterval = setInterval(() => {
                AudioCtrl.playScan();
            }, 120);

            gantryInterval = setInterval(() => {
                els.gantryAngle.innerText = (Math.random() * 360).toFixed(1);
            }, 100);

            setTimeout(stopTreatment, 3000);
        }

        function stopTreatment() {
            clearInterval(scanInterval);
            clearInterval(soundInterval);
            clearInterval(gantryInterval);
            
            const finalIndex = Math.floor(Math.random() * state.candidates.length);
            const winnerName = state.candidates[finalIndex];

            state.candidates.splice(finalIndex, 1);
            state.winners.unshift({ name: winnerName, round: state.winners.length + 1 });
            
            saveState();

            state.isScanning = false;
            state.showResult = true;

            // æ’­æ”¾ä¸­çéŸ³æ•ˆ
            AudioCtrl.playWin();

            els.displayName.innerText = winnerName;
            els.doseRate.innerText = "0";
            updateUI();
        }

        function nextFraction() {
            state.showResult = false;
            els.displayName.innerText = "ç­‰å¾…ä¸‹å€‹ç›®æ¨™";
            updateUI();
        }

        // --- UI æ›´æ–°é‚è¼¯ ---
        function updateUI() {
            els.countRemaining.innerText = state.candidates.length;
            els.countTotal.innerText = state.candidates.length + state.winners.length;

            if (state.showResult) {
                els.btnBeam.classList.add('hidden');
                els.btnNext.classList.remove('hidden');
            } else {
                els.btnBeam.classList.remove('hidden');
                els.btnNext.classList.add('hidden');
                
                if (state.isScanning) {
                    els.btnBeam.disabled = true;
                    els.btnTextBeam.innerText = "IRRADIATING...";
                    els.btnIconBeam.classList.add('animate-spin');
                } else {
                    els.btnBeam.disabled = state.candidates.length === 0;
                    els.btnTextBeam.innerText = state.candidates.length === 0 ? "EMPTY" : "BEAM ON";
                    els.btnIconBeam.classList.remove('animate-spin');
                }
            }

            if (state.isScanning) {
                els.statusText.innerText = "BEAM ON";
                els.statusText.classList.add('text-yellow-400', 'animate-pulse');
                els.statusText.classList.remove('text-green-400');
                els.headerIcon.classList.add('text-yellow-400', 'animate-spin');
                els.headerIcon.classList.remove('text-green-500');
                els.headerGlow.classList.remove('opacity-0');
                els.headerGlow.classList.add('animate-pulse');
                
                els.scanOverlay.classList.remove('opacity-20');
                els.scanOverlay.classList.add('opacity-100');
                els.scanCircle.classList.add('animate-ping');
                els.targetStatus.innerText = "LOCKING...";
            } else {
                els.statusText.innerText = "READY";
                els.statusText.classList.remove('text-yellow-400', 'animate-pulse');
                els.statusText.classList.add('text-green-400');
                els.headerIcon.classList.remove('text-yellow-400', 'animate-spin');
                els.headerIcon.classList.add('text-green-500');
                els.headerGlow.classList.add('opacity-0');
                els.headerGlow.classList.remove('animate-pulse');
                
                els.scanOverlay.classList.add('opacity-20');
                els.scanOverlay.classList.remove('opacity-100');
                els.scanCircle.classList.remove('animate-ping');
                els.targetStatus.innerText = state.showResult ? "LOCKED" : "SEARCHING...";
            }

            if (state.showResult) {
                els.displayName.classList.add('winner-effect');
                els.displayName.classList.remove('text-green-500');
                els.lockedMsg.classList.remove('hidden');
                els.congratsTag.classList.remove('hidden');
            } else {
                els.displayName.classList.remove('winner-effect');
                els.displayName.classList.add('text-green-500');
                els.lockedMsg.classList.add('hidden');
                els.congratsTag.classList.add('hidden');
            }

            renderLists();
        }

        function renderLists() {
            if (state.winners.length === 0) {
                els.winnersList.innerHTML = '<div class="text-center text-gray-500 py-8 text-sm italic">No treatment history.</div>';
            } else {
                els.winnersList.innerHTML = state.winners.map(w => `
                    <div class="flex items-center justify-between bg-green-900/30 p-2 rounded border-l-4 border-yellow-500 mb-2 animate-pulse-fast" style="animation-iteration-count: 1;">
                        <span class="text-white font-bold">${w.name}</span>
                        <span class="text-xs text-green-400 font-mono">#${w.round}</span>
                    </div>
                `).join('');
            }
            els.candidatesPreview.innerText = state.candidates.join(', ');
        }

        // --- Modal & Toast Utils ---
        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.className = `px-6 py-3 rounded shadow-lg text-white font-bold mb-2 flex items-center gap-2 animate-toast ${isError ? 'bg-red-600 border border-red-400' : 'bg-green-600 border border-green-400'}`;
            toast.innerHTML = isError 
                ? `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg> ${message}`
                : `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> ${message}`;
            
            els.toastContainer.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) toast.remove();
            }, 3000);
        }

        // --- è¨­å®šè¦–çª—é‚è¼¯ ---
        function openSettings() {
            els.settingsInput.value = state.candidates.join('\n');
            updateSettingsCount();
            els.settingsModal.classList.remove('hidden');
        }

        function closeSettings() {
            els.settingsModal.classList.add('hidden');
        }

        function saveSettings() {
            const newNames = els.settingsInput.value.split('\n').map(n => n.trim()).filter(n => n !== '');
            if (newNames.length === 0) {
                showToast("åå–®ä¸èƒ½ç‚ºç©ºï¼", true);
                return;
            }
            state.candidates = newNames;
            state.showResult = false;
            els.displayName.innerText = "ç³»çµ±å°±ç·’";
            
            saveState();
            closeSettings();
            updateUI();
            showToast("åå–®å·²æ›´æ–°");
        }

        // --- é‡ç½®é‚è¼¯ ---
        function openResetModal() {
            els.resetModal.classList.remove('hidden');
        }

        function closeResetModal() {
            els.resetModal.classList.add('hidden');
        }

        function confirmFullReset() {
            const winnerNames = state.winners.map(w => w.name).reverse();
            state.candidates = [...state.candidates, ...winnerNames];
            state.winners = [];
            state.showResult = false;
            els.displayName.innerText = "ç³»çµ±å°±ç·’";
            
            els.settingsInput.value = state.candidates.join('\n');
            
            saveState();
            closeResetModal();
            closeSettings();
            updateUI();
            showToast("ç³»çµ±å·²é‡ç½®ï¼Œåå–®å·²é‚„åŸ");
        }

        // ä½¿ç”¨ DOMContentLoaded ç¢ºä¿å…ƒç´ è¼‰å…¥å®Œæˆ
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>